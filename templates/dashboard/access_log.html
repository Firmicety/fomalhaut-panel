{% extends "base.html" %}
{% load staticfiles %}
{% block ng_app_config %}ng-app="app"{% endblock %}
{% block title %}{{ request.page_title }}{% endblock %}
{% block ng_app_body_scope %}ng-controller="appCtrl"{% endblock %}

{% block style_block %}
    <link href="/static/vendors/datetime-picker/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <link href="/static/vendors/bootstrap-select/css/bootstrap-select.css" rel="stylesheet">
{% endblock %}

{% block head_script %}
{% endblock %}

{% block main_content %}
    <div class="main-content">

        <div class="page-header clearfix">
            <div class="float-left">
                <h1 style="display: inline-block; margin-right: 10px">{{ request.page_title }}</h1>

                {% verbatim %}
                <button class="btn btn-default" style="margin-top: -6px;" ng-click="refreshLog($event)"
                        data-toggle="tooltip" data-placement="top" title="立即更新访问日志">
                    <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                    刷新
                </button>
                {% endverbatim %}
            </div>
            {% verbatim %}
            <div class="float-right">
                <div style="width: 150px;display: inline-flex">
                    <select id="select-access-agent" class="selectpicker" multiple
                            data-selected-text-format="count>3"
                            ng-model="selectedAgents">
                        <option value="-1">所有应用</option>
                        <option data-divider="true"></option>
                        <option ng-repeat="u in accessAgentOptions" value="{{ $index }}">{{ u.name }}
                        </option>
                    </select>
                </div>
                <div style="width: 150px;display: inline-flex"
                     data-container="body" data-toggle="popover" data-trigger="hover" data-placement="left"
                     data-content="访问结果：Success（成功），Forbidden（未通过令牌验证），Proxy Failed（后端网站未正确响应），Expired Token（鉴权令牌过期），Login Validated Failed（App 登录验证失败），Unknown（未知）">
                    <select id="select-access-results" class="selectpicker" multiple
                            data-selected-text-format="count>1"
                            ng-model="selectedResults">
                        <option value="-1">所有结果</option>
                        <option data-divider="true"></option>
                        <option value="0">Success</option>
                        <option value="1">Forbidden</option>
                        <option value="2">Proxy Failed</option>
                        <option value="5">Expired Token</option>
                        <option value="3">Login Validated Failed</option>
                        <option value="4">Unknown</option>
                    </select>
                </div>
                <div style="width: 150px;display: inline-flex">
                    <div class="input-group date" id="date-time"
                         data-toggle="tooltip" data-placement="top" title="选择指定日期的日志">
                        <input size="16" class="form-control" ng-model="selectedDate"
                               ng-change="selectedDateChange()"
                               type="text" value="" readonly>
                        <span class="input-group-addon">
                            <i class="glyphicon glyphicon-calendar"></i></span>
                    </div>
                </div>
                <div style="display: inline-flex">
                    <div class="icon-addon addon-md right-search-box">
                        <input type="text" placeholder="搜索过滤" class="form-control" ng-model="query">
                        <label class="glyphicon glyphicon-search"></label>
                    </div>
                </div>
            </div>
            {% endverbatim %}
        </div>

        {% verbatim %}
        <div class="table-responsive">
            <table class="table table-hover table-striped" id="table-data">
                <thead>
                <tr>
                    <th class="">#</th>
                    <th class="col-md-1">应用名</th>
                    <th class="col-md-1">站点名</th>
                    <th class="col-md-4">URL</th>
                    <th class="col-md-1">Remote IP</th>
                    <th class="col-md-2">时间</th>
                    <th class="col-md-1">耗时</th>
                    <th class="col-md-1">状态码</th>
                    <th class="col-md-1">结果</th>
                </tr>
                </thead>
                <tbody id="tbody-data">

                <script type="text/ng-template" id="entry_renderer.html">
                    <td ng-bind="page_info.offset + $index+1"></td>
                    <td class="break-word" ng-bind="entry.agent_name"></td>
                    <td class="break-word" ng-bind="entry.site_name"></td>
                    <td class="break-word" ng-bind="entry.method + ' ' + entry.url"></td>
                    <td class="break-word" ng-bind="entry.remote_ip"></td>
                    <td class="break-word" ng-bind="entry.time"></td>
                    <td ng-bind="entry.elapsed + 'ms'"></td>
                    <td ng-bind="entry.status_code"></td>
                    <td style="display: inline-block" ng-if="entry.header_token">
                        <span class="label"
                              data-toggle="tooltip" data-placement="top" title="鉴权令牌位于 Header 中，属于一次 Page View"
                              ng-class="{'label-success': entry.result_code == 0,
                              'label-warning': entry.result_code == 2 || (entry.result_code == 0 && entry.status_code >= 400),
                              'label-info':  entry.result_code == 3 || entry.result_code == 5,
                              'label-danger': entry.result_code == 1 || entry.result_code == 4}">
                            {{ entry.access_result }}
                            &nbsp;<span class="glyphicon glyphicon-flag"></span>
                        </span>
                    </td>
                    <td style="display: inline-block" ng-if="!entry.header_token">
                        <span class="label"
                              ng-class="{'label-success': entry.result_code == 0,
                              'label-warning': entry.result_code == 2 || (entry.result_code == 0 && entry.status_code >= 400),
                              'label-info':  entry.result_code == 3 || entry.result_code == 5,
                              'label-danger': entry.result_code == 1 || entry.result_code == 4}">
                            {{ entry.access_result }}
                        </span>
                    </td>
                </script>
                <tr ng-repeat="entry in entries | filter:query" ng-include="'entry_renderer.html'"></tr>

                </tbody>
            </table>
        </div>

        <div class="page-footer">
            <script type="text/ng-template" id="pagination_render.html">
                <div style="display: inline-block;margin-left: -190px;">
                    <ul class="pagination">
                        <li ng-if="page_info.has_previous_page">
                            <a href="#" ng-click="getData(page_info.previous_page)">&laquo;上一页</a></li>
                        <li ng-if="!page_info.has_previous_page" class="disabled"><a href="#">&laquo; 上一页</a></li>
                        <!--加上 track by $index，否则会出现错误 Error: ngRepeat:dupes Duplicate Key in Repeater-->
                        <li ng-repeat="pi in page_info.page_list track by $index"
                            ng-class="page_info.active==$index+1 ? 'active' : ''">
                            <a ng-click="getData(pi=='...' ? null : pi)" href="#">
                                <span ng-bind="pi"></span>
                                <span ng-if="page_info.active==$index+1" class="sr-only">(current)</span></a>
                        </li>
                        <li ng-if="page_info.has_next_page">
                            <a href="#" ng-click="getData(page_info.next_page)">下一页 &raquo;</a>
                        </li>
                        <li ng-if="!page_info.has_next_page" class="disabled"><a href="#">下一页 &raquo;</a></li>
                    </ul>
                </div>


                <div style="display: inline-block; margin-top: 20px;margin-left: 10px;position: absolute;">
                    <input style="width:60px;display: inline-block;"
                           ng-model="jumpPage.jumpPageId"
                           type="text" class="form-control" placeholder="页码">
                    <button style="display: inline-block;margin-top: -3px;" type="submit" class="btn btn-default"
                            ng-click="jumpPage.doJumpPage()">跳转
                    </button>
                    <span style="margin-left: 10px">共 {{ page_info.total_num }} 项</span>
                </div>

            </script>

            <div class="text-center" ng-show="page_info.display" ng-include="'pagination_render.html'">
            </div>

        </div>
        {% endverbatim %}
    </div>
{% endblock %}

{% block tail_script %}
    <script src="/static/vendors/datetime-picker/bootstrap-datetimepicker.min.js"></script>
    <script src="/static/vendors/datetime-picker/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="/static/vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="/static/js/dashboard/access_log.js"></script>
{% endblock %}